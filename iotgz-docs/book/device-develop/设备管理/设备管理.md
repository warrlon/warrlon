# 清华大学校园物联应用综合管理服务平台使用手册  

# 平台简介

清华大学物联平台，围绕信息建设“统一谋划、统一部署、统一推进、统一实施”的建设方针，通过制定统一的物模型、场景建设、数据、安全、泛协议接入和开放集成的标准，降低校园各板块数字化信息互通联动壁垒，加速实现校园终端统一接入、集中管理，多板块协同、开放共享，推动校园业务通过数据一致性支撑业务快速创新。  

# Dasgboard

在左侧边导航栏中选择【Dashboard】，进入页面。该页面主要展示内容包括产品信息和设备信息的相关统计信息。  

![Dasgboard](/images\device-management\Dasgboard.png)

# 设备管理

## 产品管理

在左侧边导航栏中选择【设备管理】，点击选择【产品管理】，进入产品管理页面，该页面默认展示【我的产品】内容，可切换查看【授权产品】相关内容。

![产品管理](/images\device-management\产品管理.png)

该页面支持以下功能：

- 支持用户基于【我的产品】相关功能进行操作
- 支持用户基于【授权产品】相关功能进行操作

### 我的产品

用户进入【产品管理】页面，该页面默认展示【我的产品】信息，具体包括产品名称、产品ID、行业类型、节点类型、接入协议、设备总数、添加时间。

![我的产品](/images\device-management\我的产品.png)

该页面支持以下功能：

- 支持用户通过产品名称、产品厂商、产品型号和标签进行搜索功能
- 支持产品详情查看功能
- 支持跳转设备管理页面功能
- 支持产品添加功能
- 支持产品删除功能
以添加产品和详情查看为例，进行重点阐述。

#### 添加产品

用户点击【添加产品】，进入添加页面。添加产品主要通过产品名称、所属行业、产品类型、物模型、节点类型、接入协议、数据协议、联网方式、和更多设置进行添加，点击确定后系统返回结果并在前端进行显示。

![添加产品](/images\device-management\添加产品.png)

其中，添加产品中行业类型可选择智慧城市、智慧生活、智慧工业、智慧园区、智慧商业、智慧农业、智慧楼宇、智慧交通、智慧物流、医疗健康、智慧教育、智慧电力、智慧社区、清华大学、其他行业。

![选择产品类别](/images\device-management\选择产品类别.png)

用户可选择某行业类型下，选择其对应应用场景的产品类别，支持查看该类别标准物模型。

![标准物模型](/images\device-management\标准物模型.png)

#### 详情查看

用户点击【详情】按钮，进入产品详情页面。该页面默认展示【物模型管理】信息，可切换查看【生产档案】信息。
该页面支持以下功能：

- 支持用户管理产品信息：编辑产品内容、添加/编辑产品标签
- 支持用户基于【物模型管理】功能进行相关操作
- 支持用户基于【设备生产档案】功能进行相关操作

### 授权产品

在左侧边导航栏中选择【设备管理】，点击选择【产品管理】，进入产品管理页面，点击切换到【授权产品】信息，具体包括产品名称、产品ID、行业类型、节点类型、接入协议、来源用户、设备总数、添加时间。
该页面支持以下功能：

- 支持用户通过产品名称进行搜索功能
- 支持授权产品详情查看功能
- 支持进入设备管理页面功能

## 开发产品物模型

### 什么是物模型

[中国移动IOT物模型标准白皮书V1.0.0](https://upfiles.heclouds.com/portal5-admin/portal5-admin/2022/03/14/4ed1223472bf7e25d16f021f5b839b5b.pdf)  
**1. 定义**

物模型是对设备的数字化抽象描述，描述该型号设备是什么，能做什么，能对外提供哪些服务。
物模型将物理空间中的实体设备数字化，在云端构建该实体的数据模型，即将物理空间的实体在云端进行格式化表示。

![物模型定位](/images\device-management\物模型定位.png)

如上图所示，物模型属于应用协议之上的语法语义层。在物联网平台中，物模型完成对终端产品形态，产品功能的结构化定义，包括终端设备业务数据的格式和传输规则

物模型功能模块在物联网平台中的位置如图所示：

![物模型功能](/images\device-management\物模型功能.png)

物模型在业务逻辑属于物联网平台的设备管理模块。用于实现不同设备能够以统一的物模型标准对接应用平台，不同应用之间能够以统一物模型标准进行数据互通。
**2. 设备抽象模型**

物模型基础功能分为三类：属性、服务、事件，功能点数量不超过100个。

<table>
<tr><th width="15%">功能类型</th><th width="85%">说明
<tr><td>属性</td><td>用于描述设备的动态特征，包括运行时的状态，应用可发起对属性的读取和设置请求。</td>
<tr><td>服务</td><td>用于描述终端设备可被外部调用的能力，可设置输入参数和输出参数。服务可实现复杂的业务逻辑，例如执行某项特定的任务；支持同步或异步返回结果。</td>
<tr><td>事件</td><td>设备运行时可以被触发的上行消息，如设备运行的记录信息，设备异常时发出的告警、故障信息等；可包含多个输出参数。</td>
</table>

功能类别分为三类：系统、标准、自定义，可为属性、服务、事件三者任意组合。

<table>
<tr><th width="15%">功能类型</th><th width="85%">说明</th></tr>
<tr><td>系统功能点</td><td>此类功能点多数与平台提供的服务有关，如LBS定位服务、OneNET设备认证服务等。</td>
<tr><td>标准功能点</td><td>此类功能点多数与产品行业类别相关，为标准行业产品抽象出的一套标准的功能点。</td>
<tr><td>自定义功能点</td><td>此类功能点为用户自定义，产品非标准设备，用户按设备实际情况添加设备功能点，自由度较大。</td>
</table>

**3. 数据类型支持**

<table>
<tr><th width="15%">类型</th><th>说明</th><th width="70%">标识符</th></tr>
<tr><td>整数型</td><td>int32、int64</td><td>整数、长整数</td></tr>
<tr><td>浮点型</td><td>float、double</td><td>单精度浮点、双精度浮点</td></tr>
<tr><td>时间类型</td><td>date</td><td>长整数的扩展类型，整数类型int64的UTC时间戳（毫秒）</td></tr>
<tr><td>布尔型</td><td>bool</td><td>true或false</td></tr>
<tr><td>字符型</td><td> string</td><td> 字符串，文本类型</td></tr>
<tr><td>枚举型</td><td>enum</td><td>枚举类型，枚举值为整数</td></tr>
<tr><td>位图型</td><td>bitMap</td><td>位图，多用于多个故障信号同时上送，非传统意义的图片数据</td></tr>
<tr><td>数组类型</td><td>array</td><td>数组类型，元素类型支持：int32、int64、float、double、string、date、struct</td></tr>
<tr><td>结构图</td><td> struct</td><td> 结构图类型，仅支持一层嵌套，成员类型不支持数组</td></tr>
</table>

**特别说明：**

<table>
<tr><th width="20%">类型</th><th>比特数</th><th>有效数字</th><th width="40%">数值范围</th></tr>
<tr><td>float</td><td>32</td><td>6-7</td><td>-3.4*10^(-38)～3.4*10^(38)</td></tr>
<tr><td>double</td><td>64</td><td>15-16</td><td>-1.7*10^(-308)～1.7*10^(308)</td></tr>
</table>

**4. 物模型描述文件说明**

<table>
<tr><th width="15%">名称</th><th width="85%">描述</th></tr>
<tr><td>properties</td><td>属性点集合</td>
<tr><td>events</td><td>事件点集合</td>
<tr><td>services</td><td>服务点集合</td>
<tr><td>identifier</td><td>功能点标识符/参数标识符，以"$"开始为系统功能点，功能点标识符产品下唯一</td>
<tr><td>name</td><td>功能点名字，用户自定义</td>
<tr><td>functionType</td><td>功能类型，用户自定义(u)/系统功能点(s)/标准功能点(st)</td>
<tr><td>accessMode</td><td>读写类型，只读(r)/读写(rw)</td>
<tr><td>dataType</td><td>数据描述集合</td>
<tr><td>type</td><td>数据类型</td>
<tr><td>eventType</td><td>事件类型：信息（info）、告警（alert)、故障(error)</td>
<tr><td>specs</td><td>数据类型描述的时候存在</td>
<tr><td>desc</td><td>用户自定义描述</td>
<tr><td>inputData</td><td>输入参数集合</td>
<tr><td>outputData</td><td>输出参数集合</td>
</table>

### 物模型管理

平台支持单个添加物模型功能点和批量添加物模型功能点。
**1. 单个添加物模型功能点**

点击「产品管理」页，产品列表中对应产品的「详情」操作，进入物模型设置页面，点击「设置物模型」，根据需求添加或选择物模型功能点，完成功能点编辑后，点击「保存」，使物模型模板生效。
**2. 批量添加物模型功能点**

在「产品详情」页面，点击「设置物模型」，进入物模型编辑状态，然后点击「导入物模型」，选择物模型模板文件，点击「导入」确认，最后点击「保存」使物模型模板生效。

**3. 导出物模型模板**
在「产品详情」页面，点击「查看/导出物模型」，下载产品物模型描述文件

**4. 物模型SDK下载**
在「产品详情」页面，点击「下载设备端SDK」，下载设备端物模型代码，结合[设备接入SDK](https://open.iot.10086.cn/doc/v5/develop/detail/625)进行开发

## 物模型通信协议

### OneJSON简介  

**1. 协议简介**

OneJSON协议是针对物联网开发领域设计的一种数据交换规范，数据格式是JSON，用于设备端和物联网平台的双向通信，更便捷地实现和规范了设备端和物联网平台之间的业务数据交互。  

**2. 设备接入**

设备接入流程，可以按照设备类型，分为直连设备和子设备接入。主要包括：设备注册、上线、绑定拓扑和数据上报三个流程。
![设备接入流程](/images\device-management\设备接入流程.png)

**3. 设备上报属性或事件**

![设备上报属性或事件](/images\device-management\设备上报.png)
(1) 设备使用OneJSON指定主题，上报数据
(2) 平台对数据进行业务处理，包含格式验证、数据存储等，如果配置了规则引擎，数据将流转到用户配置的消息目的地，推送方式支持HTTP(s)、MQ等
(3) 平台返回数据上报结果
(4) 开发者也可以通过控制台或公开API查询上报的数据

**4. 设备属性获取**

![设备属性获取](/images\device-management\设备属性获取.png)
(1) 开发者通过公开API或控制台发起获取属性请求
(2) 平台将根据物模型定义验证请求参数
(3) 平台将数据请求发给设备
(4) 平台等待设备响应，如果等待超时，将返回超时错误信息
(5) 设备处理完请求之后，把需要的设备属性返回给平台
(6) 平台收到设备最新属性后，对设备属性进行校验，将结果返回给开发者

**5. 设备服务调用及属性设置**

- 同步服务调用及属性设置
![设备服务同步调用](/images\device-management\异步调用.png)
(1) 通过调用对应API接口来调用同步服务（定义服务时，调用方式选择为同步的服务即为同步调用）
(2) 平台将根据物模型定义验证输入参数
(3) 平台将数据下发给设备
(4) 平台等待设备响应，如果等待超时，将返回相应错误信息
(5) 设备处理完数据之后，把处理结果返回给平台
(6) 平台收到设备处理结果后，对设备输出参数进行校验，将结果返回给开发者

- 异步服务调用及属性设置
![设备服务异步调用](/images\device-management\同步调用.png)
(1) 通过调用对应API接口来调用同步服务（定义服务时，调用方式选择为异步的服务即为异步调用）
(2) 平台对输出参数进行校验，并返回处理结果给开发者
(3) 平台采用异步方式将数据下发
(4) 设备收到数据后，进行业务处理
(5) 设备完成业务处理后，返回处理结果给平台
(6) 平台对设备返回的输出参数进行验证
(7) 如果配置了规则引擎，数据将流转到用户配置的消息目的地，推送方式支持HTTPS、MQ等

**6. 拓扑关系**
![拓扑关系](/images\device-management\拓扑关系.png)
网关和子设备绑定拓扑关系后，子设备可借助网关通道进行上下线、数据上传、指令接收等操作
网关和子设备拓扑关系可以通过两种方式变更：

- 北向修改
(1) 开发者在控制台绑定或解绑子设备
(2) 开发者点击同步操作，将拓扑关系变更通知到网关
(3) 网关收到拓扑关系后，进行网关本地拓扑关系同步
(4) 同步结果返返回平台
(5) 平台处理后，将最终结果返回给开发者

- 南向修改
(1) 网关侧发起关联或解绑子设备操作
(2) 平台处理完网关请求后，将处理结果返回给网关设备

- 拓扑关系获取
(1) 网关可主动向平台获取拓扑关系
(2) 平台下发拓扑关系到网关
(3) 网关本地同步云平台存储的拓扑关系到本地
(4) 网关回复本地同步结果

### 设备属性/事件

**1. 设备属性上报**

上行(OneJSON）

>- 请求topic: $sys/{pid}/{device-name}/thing/property/post

OneJSON数据格式:
> {
  "id": "123",
  "version": "1.0",
  "params": {
    "Power": {
      "value": "on",
      "time": 1524448722123
    },
    "WF": {
      "value": 23.6,
      "time": 1524448722123
    }
  }
}

表：请求参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>IntegerString</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>JsonObject</td><td>请求参数，用户自定义，标准json格式。如以上示例中，设备上报了的两个属性Power和WF。具体属性信息，包含属性上报时间（time）和上报的属性值（value）</td></tr>
<tr><td>time</td><td>Long</td><td>属性值生成时间。该参数为可选字段，到豪秒级。根据您的业务场景决定消息中是否带时间戳。如果消息频繁，需根据时间戳判断消息顺序，建议消息中带有时间戳</td></tr>
<tr><td>value</td><td>Object</td><td>上报的属性值</td></tr>
</table>

>- 响应topic: $sys/{pid}/{device-name}/thing/property/post/reply

OneJSON数据格式:
> {
  "id": "123",
  "code":200,
  "msg":"xxxx"
}

表：响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码</td></tr>
<tr><td>msg</td><td>String</td><td>错误消息</td></tr>
</table>

**2. 设备属性设置**

下行(OneJSON):

>- 请求topic: $sys/{pid}/{device-name}/thing/property/set

OneJSON数据格式：
> {
  "id": "123",
  "version": "1.0",
  "params": {
    "temperature":"30.5"
  }
}

表：请求参数描述:

<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>JsonObject</td><td>属性设置参数。如以上示例中，设置属性：{"temperature":"30.5" }</td></tr>
</table>

>- 响应topic: $sys/{pid}/{device-name}/thing/property/set_reply

OneJSON数据格式：
> {
    "id":"123",
    "code":200,
    "msg":"xxxx"
}

表：响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码</td></tr>
<tr><td>msg</td><td>String</td><td>错误消息</td></tr>
</table>

**3. 设备属性获取**
下行(OneJSON):
>
>- 请求topic: $sys/{pid}/{device-name}/thing/property/get

OneJSON数据格式：
> {
    "id":"123",
    "version":"1.0",
    "params":[
        "temperature",
        "humidity"
    ]
}

表：请求参数描述

<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>JsonObject</td><td>获取属性最新值的标识符列表</td></tr>
</table>

>- 响应topic: $sys/{pid}/{device-name}/thing/property/get_reply

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxx",
    "data":{
        "temperature":39.5,
        "humidity":20
    }
}

表：响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码,用户自定义</td></tr>
<tr><td>msg</td><td>String</td><td>错误消息</td></tr>
<tr><td>data</td><td>JsonObject</td><td>获取属性最新值列表</td></tr>
</table>

**4. 设备事件上报**

上行(OneJSON)

>- 请求topic: $sys/{pid}/{device-name}/thing/event/post

OneJSON数据格式:
> {
    "id":"123",
    "version":"1.0",
    "params":{
        "identifier1":{
            "value":{
                "Power":"on",
                "WF":"2"
            },
            "time":1524448722123
        },
        "identifier2":{
            "value":{
                "Power":"on",
                "WF":"2"
            },
            "time":1524448722123
        }
    }
}

表：请求参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>JsonObject</td><td>上报事件的参数</td></tr>
<tr><td>time</td><td>Long</td><td>属性值生成时间。该参数为可选字段，到豪秒级。根据您的业务场景决定消息中是否带时间戳。如果消息频繁，需根据时间戳判断消息顺序，建议消息中带有时间戳</td></tr>
<tr><td>value</td><td>Object</td><td>具体的事件信息。如以上示例中{ "Power": "on", "WF": "2"}</td></tr>
</table>

>- 具体的事件信息。如以上示例中{ "Power": "on", "WF": "2"}

OneJSON数据格式:
> {
  "id": "123",
  "code":200,
  "msg":"xxxx"
}

表：响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码</td></tr>
<tr><td>msg</td><td>String</td><td>错误消息</td></tr>
</table>

**5. 批量数据上报**
上行(OneJSON)

>- 请求topic: $sys/{pid}/{device-name}/thing/pack/post
说明：
每次批量上送不超过10个子设备，每个设备上送数据点数量不超过100个

OneJSON数据格式:

> {
    "id":"123",
    "version":"1.0",
    "params":[
        {
            "identity":{
                "productID":"",
                "deviceName":""
            },
            "properties":{
                "Power":{
                    "value":"on",
                    "time":1524448722000
                },
                "WF":{
                    "value":"3",
                    "time":1524448723000
                }
            },
            "events":
                {
                    "alarmEvent1":{
                        "value":{
                            "Power":"on",
                            "WF":"2"
                        },
                        "time":1524448722000
                    },
                    "alarmEvent2":{
                        "value":{
                            "Power":"on",
                            "WF":"2"
                        },
                        "time":1524448722000
                    }
                }
        },
        {
            "identity":{
                "productID":"",
                "deviceName":""
            },
            "properties":{
                "Power":{
                    "value":"on",
                    "time":1524448722000
                },
                "WF":{
                    "value":"3",
                    "time":1524448723000
                }
            },
            "events":
                {
                    "alarmEvent1":{
                        "value":{
                            "Power":"on",
                            "WF":"2"
                        },
                        "time":1524448722000
                    },
                    "alarmEvent2":{
                        "value":{
                            "Power":"on",
                            "WF":"2"
                        },
                        "time":1524448722000
                    }
                }
        }
    ]
}

表：请求参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>Object</td><td>请求参数</td></tr>
<tr><td>properties</td><td>Object</td><td>属性，包含属性标识符、属性值value 和属性生成的时间time。其中，time参数为可选字段。根据您的业务场景决定消息中是否带时间戳。如果消息频繁，需根据时间戳判断消息顺序，建议消息中带有时间戳</td></tr>
<tr><td>events</td><td>Object</td><td>事件，包含事件标识符、事件输出参数value和事件生成的时间time。其中，time参数为可选字段。根据您的业务场景决定消息中是否带时间戳。如果消息频繁，需根据时间戳判断消息顺序，建议消息中带有时间戳</td></tr>
<tr><td>identity</td><td>Object</td><td>设备信息，可选字段，如果有此字段，内容为子设备信息</td></tr>
<tr><td>productID</td><td>String</td><td>子设备产品key</td></tr>
<tr><td>deviceName</td><td>String</td><td>子设备名称</td></tr>
</table>

>- 响应topic: $sys/{pid}/{device-name}/thing/pack/post/reply

OneJSON数据格式:
> {
  "id": "123",
  "code": 200,
  "msg":"xxxx"
}

表：响应参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码</td></tr>
<tr><td>msg</td><td>String</td><td>错误消息</td></tr>
</table>

**6. 历史数据上报**
上行(OneJSON)

>- 请求topic: $sys/{pid}/{device-name}/thing/history/post
说明：
每次批量上送不超过10个子设备，每个设备上送数据点数量不超过100个，每个功能点历史数据不超过100个

OneJSON数据格式:
> {
    "id":"123",
    "version":"1.0",
    "params":[
        {
            "identity":{
                "productID":"",
                "deviceName":""
            },
            "properties":{
                "Power":[
                    {
                        "value":"on",
                        "time":1524448722000
                    },
                    {
                        "value":"off",
                        "time":1524448723000
                    }
                ],
                "WF":[
                    {
                        "value":"3",
                        "time":1524448723000
                    },
                    {
                        "value":"3",
                        "time":1524448724000
                    }
                ]
            },
            "events":{
                "alarmEvent1":[
                    {
                        "value":{
                            "Power":"on",
                            "WF":"2"
                        },
                        "time":1524448722000
                    },
                    {
                        "value":{
                            "Power":"off",
                            "WF":"3"
                        },
                        "time":1524448723000
                    }
                ],
                "alarmEvent2":[
                    {
                        "value":{
                            "Power":"on",
                            "WF":"2"
                        },
                        "time":1524448722000
                    },
                    {
                        "value":{
                            "Power":"off",
                            "WF":"3"
                        },
                        "time":1524448723000
                    }
                ]
            }
        },
        {
            "identity":{
                "productID":"",
                "deviceName":""
            },
            "properties":{
                "Power":[
                    {
                        "value":"on",
                        "time":1524448722000
                    },
                    {
                        "value":"off",
                        "time":1524448723000
                    }
                ],
                "WF":[
                    {
                        "value":"3",
                        "time":1524448723000
                    },
                    {
                        "value":"3",
                        "time":1524448724000
                    }
                ]
            },
            "events":{
                "alarmEvent1":[
                    {
                        "value":{
                            "Power":"on",
                            "WF":"2"
                        },
                        "time":1524448723000
                    },
                    {
                        "value":{
                            "Power":"off",
                            "WF":"3"
                        },
                        "time":1524448724000
                    }
                ],
                "alarmEvent2":[
                    {
                        "value":{
                            "Power":"on",
                            "WF":"2"
                        },
                        "time":1524448723000
                    },
                    {
                        "value":{
                            "Power":"off",
                            "WF":"3"
                        },
                        "time":1524448724000
                    }
                ]
            }
        }
    ]
}

表：请求参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>Object</td><td>请求参数</td></tr>
<tr><td>identity</td><td>String</td><td>数据所属设备的身份证书信息，包含参数productID和deviceName。**可选字段，**默认为topic信息中对应的设备数据；说明 直连设备仅能上报自己的物模型数据。网关设备可以上报其子设备的物模型数据。网关上报子设备历史数据时，identity为子设备的信息</td></tr>
<tr><td>properties</td><td>Object</td><td>属性，包含属性标识符、属性值value 和属性生成的时间time</td></tr>
<tr><td>events</td><td>Object</td><td>事件，包含事件标识符、事件输出参数value和事件生成的时间time</td></tr>
<tr><td>productID</td><td>String</td><td>子设备产品key</td></tr>
<tr><td>deviceName</td><td>String</td><td>子设备名称</td></tr>
</table>

>- 响应topic: $sys/{pid}/{device-name}/thing/history/post/reply

OneJSON数据格式:
> {
  "id": "123",
  "code": 200,
  "msg":"xxxx"
}

表：响应参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码</td></tr>
<tr><td>msg</td><td>String</td><td>错误消息</td></tr>
</table>

### 设备服务调用

**1. 设备服务调用**
物联网平台支持同步调用和异步调用，同步调用超时时间5s，异步调用无超时时间
下行(OneJSON）

>- 请求topic: $sys/{pid}/{device-name}/thing/service/{identifier}/invoke

OneJSON数据格式:
> {
    "id":"123",
    "version":"1.0",
    "params":{
        "Power1":"on",
        "WF1":"2"
    }
}

表：请求参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>ididentifier</td><td>String</td><td>功能点唯一标识符（产品下唯一）</td></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>结果状态码,物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>Object</td><td>服务的请求参数，参数类型具体见物模型对应的“服务”定义（输入参数部分）

{
"Power1":"on",
"WF1":"2"
}</td></tr>
</table>

>- 响应topic: $sys/{pid}/{device-name}/thing/service/{identifier}/invoke_reply

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxxx",
    "data":{
        "result1":"on",
        "result2":"2"
    }
}

表：响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码</td></tr>
<tr><td>msg</td><td>String</td><td>错误消息</td></tr>
<tr><td>data</td><td>Object</td><td>服务的响应参数，参数类型具体见物模型对应的“服务”定义（输出参数部分）

{
"result1":"on",
"result2":"2"
}</td></tr>
</table>

说明:

- 同步调用，返回以上结果；
- 异步调用，平台收到服务调用请求后立即返回以上结果给应用，但是不包含data字段；平台收到设备响应后，按以上结果（含data字段）将数据通过规则引擎流转MQ、推送或数据存储，用户通过MQ、HTTP推送等服务获取设备服务执行结果，也可通过「设备详情」-「服务记录」查看相关执行结果，亦可通过api查询获取执行结果。

### 设备期望属性值

**1. 属性期望值流程**
在平台设置属性期望值后，平台更新属性期望值，若设备在线，将实时异步更新设备属性状态；若设备离线，期望值属性值将缓存在平台，待设备上线后，设备可主动获取属性期望值，设备业务处理后，并选择是否上报属性最新状态；

![属性期望值流程](/images\device-management\期望值流程.png)
**2. 属性期望值获取**

>- 请求topic: $sys/{pid}/{device-name}/thing/property/desired/get

OneJSON数据格式：
> {
    "id" : "123",
    "version":"1.0",
    "params" : [
        "power",
        "temperature"
    ]
}

表：请求参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>JsonObject</td><td>获取属性期望的标识符列表</td></tr>
</table>

>- 响应topic:$sys/{pid}/{device-name}/thing/property/desired/get/reply

OneJSON数据格式：
> {
    "id":"123",
    "code":200,
    "msg":"xxxx"
    "data":{
        "power": {
            "value": "on",
            "version": 2
        }
    }
}

表：响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码</td></tr>
<tr><td>msg</td><td>String</td><td>错误消息</td></tr>
<tr><td>data</td><td>Object</td><td>1.返回的期望值信息。若未在云端设置过该属性的期望值，或期望值属性被清空，返回对象中不包含该属性的标识符。key：属性标识符value：期望值version：当前期望属性值的版本。首次设置属性期望值后，版本为1。以后每次设置，版本号自增；清空期望值再设置期望值，版本号重新从1开始2.如果状态未成功，msg为携带的错误信息</td></tr>
</table>

**3. 属性期望值清除**

>- 请求topic:$sys/{pid}/{device-name}/thing/property/desired/delete

OneJSON数据格式：
> {
    "id": "123",
    "version": "1.0",
    "params": {
        "power": {
            "version": 1
        },
        "temperature": { }
    }  
}

表：请求参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>JsonObject</td><td>要清除期望的属性信息列表。key：标识符version：要删除期望属性的版本号。如果指定为1，标识平台最新版本是1时执行清除。如果指定版本为1，但平台最新版本是大于1，则忽略这个清除请求。若请求中，未指定要清除的期望值版本version，则不验证版本号，直接清除期望值</td></tr>
</table>

>- 响应topic:$sys/{pid}/{device-name}/thing/property/desired/delete/reply

OneJSON数据格式：
> {
    "id":"123",
    "code":200,
    "msg":"xxxx"
}

表：响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码</td></tr>
<tr><td>msg</td><td>String</td><td>错误消息</td></tr>
</table>

### 管理拓扑关系

**1. 绑定子设备**
网关类型的设备，可以通过Topic上行请求添加它和子设备之间的拓扑关系，单个网关设备最多支持添加1500个子设备
>
>- 请求topic:$sys/{pid}/{device-name}/thing/sub/topo/add

OneJSON数据格式:
> {
    "id":"123",
    "version":"1.0",
    "params":{
        "deviceName":"device1",
        "productID":"product1",
        "sasToken":"version=2018-10-31&res=products/product1/devices/device1&et=1537255523&method=sha1&sign=ZjA1NzZlMmMxYzIOTg3MjBzNjYTI2MjA4Yw%3D"
    }
}

表：请求参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td> String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>JsonObject</td><td>请求入参，包含要要绑定的子设备的信息</td></tr>
<tr><td>deviceName</td><td>String</td><td>子设备的设备名称</td></tr>
<tr><td>productID</td><td> String</td><td>子设备所属产品的productID</td></tr>
<tr><td>sasToken</td><td>String</td><td>鉴权token，具体可参考

[设备安全认证](<https://open.iot.10086.cn/doc/v5/develop/detail/624>)(<https://open.iot.10086.cn/doc/v5/develop/detail/624>)</td></tr>
</table>

>- 响应topic:$sys/{pid}/{device-name}/thing/sub/topo/add/reply

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxxx"
}

表:响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码，成功返回200</td></tr>
<tr><td>msg</td><td>String</td><td>错误消息</td></tr>
</table>

**2. 解绑子设备**
网关类型的设备，可以通过Topic上行请求解绑它和子设备之间的拓扑关系
>
>- 请求topic:$sys/{pid}/{device-name}/thing/sub/topo/delete

OneJSON数据格式:
> {
    "id":"123",
    "version":"1.0",
    "params":{
        "deviceName":"device1",
        "productID":"product1",
        "sasToken":"version=2018-10-31&res=products/product1/devices/device1&et=1537255523&method=sha1&sign=ZjA1NzZlMmMxYzIOTg3MjBzNjYTI2MjA4Yw%3D"
    }
}

表：请求参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td> String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>JsonObject</td><td>请求入参，包含要要绑定的子设备的信息</td></tr>
<tr><td>deviceName</td><td>String</td><td>子设备的设备名称</td></tr>
<tr><td>productID</td><td> String</td><td>子设备所属产品的productID</td></tr>
<tr><td>sasToken</td><td>String</td><td>鉴权token，具体可参考

[设备安全认证](<https://open.iot.10086.cn/doc/v5/develop/detail/624>)(<https://open.iot.10086.cn/doc/v5/develop/detail/624>)</td></tr>
</table>

>- 响应topic:$sys/{pid}/{device-name}/thing/sub/topo/delete/reply

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxxx"
}

**3. 获取拓扑关系**
网关类型的设备，可以获取该网关设备拓扑关系，平台返回该网关设备的拓扑，网关本地同步成功后，回复平台同步状态（控制台可查看同步状态）
>
>- 请求topic:$sys/{pid}/{device-name}/thing/sub/topo/get

OneJSON数据格式:
> {
    "id":"123",
    "version":"1.0",
}

表：请求参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>Integer</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
</table>

>- 响应topic:$sys/{pid}/{device-name}/thing/sub/topo/get/reply

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxxx",
    "data":[
        {
            "deviceName":"device1",
            "productID":"product1"
        },
        {
            "deviceName":"device2",
            "productID":"product2"
        }
    ]
}

表：响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码，成功返回200</td></tr>
<tr><td>msg</td><td>String</td><td>错误信息</td></tr>
<tr><td>data</td><td>array</td><td>请求成功时，返回的所有子设备信息</td></tr>
<tr><td>deviceName</td><td>String</td><td>子设备的设备名称</td></tr>
<tr><td>productID</td><td>String</td><td>子设备所属产品的productID</td></tr>
</table>

>- 网关同步结果响应topic: $sys/{pid}/{device-name}/thing/sub/topo/get/result

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxxx"
}

表：响应参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>返回结果，200代表成功</td></tr>
<tr><td>msg</td><td>String</td><td>结果信息，可选项</td></tr>
</table>

**4. 网关拓扑关系变化通知**
用户通过控制台或者API修改了网关的拓扑关系，平台需通知网关拓扑发生变化
>
>- 通知topic:$sys/{pid}/{device-name}/thing/sub/topo/change

OneJSON数据格式:
> {
    "id":"123",
    "version":"1.0",
    "params":{
        "subList":[
            {
                "deviceName":"device1",
                "productID":"product1"
            },
            {
                "deviceName":"device2",
                "productID":"product2"
            }
        ]
    }
}

表：请求参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td> String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>JsonObject</td><td>下发数据信息</td></tr>
<tr><td>subList</td><td>array</td><td>子设备全量列表</td></tr>
<tr><td>deviceName</td><td> String</td><td>子设备的设备名称</td></tr>
<tr><td>productID</td><td>String</td><td>子设备所属产品的productID</td></tr>
</table>

>- 响应topic:$sys/{pid}/{device-name}/thing/sub/topo/change_reply

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxxx"
}

表：响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码，成功返回200</td></tr>
<tr><td>msg</td><td>String</td><td>错误消息</td></tr>
</table>

### 子设备上下线

**1. 子设备上线**
子设备上线之前，需和网关绑定拓扑关系；
子设备上线时，平台会根据拓扑关系进行子设备验证，以确定子设备是否有使用网关通道的权利；
>若用户不关心子设备的在线状态，该流程为可选流程，子设备在线状态会显示为未知

>- 请求topic: $sys/{pid}/{device-name}/thing/sub/login
因子设备通过网关通道与物联网平台建立通信，以上topic为网关设备的topic。topic中的变量{pid}和{device-name}需替换为网关设备对应信息。

OneJSON数据格式:
> {
  "id": "123",
  "version": "1.0",
  "params": {
    "productID": "product1",
    "deviceName": "device1"
  }
}

表：请求参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>Object</td><td>请求入参，包含的具体参数见下表params</td></tr>
<tr><td>deviceName</td><td>String</td><td>子设备的设备名称</td></tr>
<tr><td>productID</td><td> String</td><td>子设备所属产品的productID</td></tr>
</table>

>- 响应topic:$sys/{pid}/{device-name}/thing/sub/login/reply
因子设备通过网关通道与物联网平台建立通信，以上topic为网关设备的topic。topic中的变量{pid}和{device-name}需替换为网关设备对应信息。

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxxx"
}

<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>返回结果，200代表成功</td></tr>
<tr><td>msg</td><td>String</td><td>结果信息，可选项</td></tr>
</table>

**2. 子设备下线**
>若用户不关心子设备的在线状态，该流程为可选流程，子设备在线状态会显示为未知

>- 请求topic:$sys/{pid}/{device-name}/thing/sub/logout
因子设备通过网关通道与物联网平台建立通信，以上topic为网关设备的topic。topic中的变量{pid}和{device-name}需替换为网关设备对应信息。

OneJSON数据格式:
> {
  "id": "123",
  "version": "1.0",
  "params": {
    "productID": "product1",
    "deviceName": "device1"
  }
}

表：请求参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>Object</td><td>请求入参，包含的具体参数见下表params</td></tr>
<tr><td>deviceName</td><td>String</td><td>子设备的设备名称</td></tr>
<tr><td>productID</td><td> String</td><td>子设备所属产品的productID</td></tr>
</table>

>- 响应topic:$sys/{pid}/{device-name}/thing/sub/logout/reply
因子设备通过网关通道与物联网平台建立通信，以上topic为网关设备的topic。topic中的变量{pid}和{device-name}需替换为网关设备对应信息。

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxxx"
}

表:响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>返回结果，200代表成功</td></tr>
<tr><td>msg</td><td>String</td><td>结果信息，可选项</td></tr>
</table>

### 子设备数据交互

**1. 子设备数据上传**
子设备数据上传采用批量上送数据通道，具体参考[设备属性/事件](https://open.iot.10086.cn/doc/v5/develop/detail/509)的「批量数据上报」或「历史数据上报」

**2. 子设备属性获取**
支持应用通过网关获取子设备属性，目前仅支持一次获取单个子设备多个属性，每次获取属性个数不超过50个，超时时间为5s
>
>- 请求topic:$sys/{pid}/{device-name}/thing/sub/property/get

OneJSON数据格式:
> {
    "id":"123",
    "version":"1.0",
    "params":{
        "deviceName":"device1",
        "productID":"product1",
        "params":[
            "temperature",
            "humidity"
        ]
    }
}

表：请求参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params（外层）</td><td>JsonObject</td><td>获取属性最新值的相关信息</td></tr>
<tr><td>deviceName</td><td>String</td><td>子设备的设备名称</td></tr>
<tr><td>productID</td><td> String</td><td>子设备所属产品的productID</td></tr>
<tr><td>params（内层）</td><td>array</td><td>请求属性标识符列表</td></tr>
</table>

>- 响应topic:$sys/{pid}/{device-name}/thing/sub/property/get_reply

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxx",
    "data":{
        "temperature":39.5,
        "humidity":20
    }
}

表：响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码，用户自定义</td></tr>
<tr><td>msg</td><td>String</td><td> 错误信息</td></tr>
<tr><td>data</td><td>JsonObject</td><td>获取属性最新值列表</td></tr>
</table>

**3. 子设备属性设置**
支持应用通过网关设置子设备属性，目前仅支持一次设置单个子设备多个属性，每次设置属性个数不超过50个，超时时间为5s
>
>- 请求topic:$sys/{pid}/{device-name}/thing/sub/property/set

OneJSON数据格式:
> {
    "id":"123",
    "version":"1.0",
    "params":{
        "deviceName":"device1",
        "productID":"product1",
        "params":{
            "temperature":"30.5",
            "humidity":"20.5"
        }
    }
}

表：请求参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params（外层）</td><td>JsonObject</td><td>设置属性值的相关信息</td></tr>
<tr><td>deviceName</td><td>String</td><td>子设备的设备名称</td></tr>
<tr><td>productID</td><td> String</td><td>子设备所属产品的productID</td></tr>
<tr><td>params（内层）</td><td>array</td><td>设置属性的值列表</td></tr>
</table>

>- 响应topic:$sys/{pid}/{device-name}/thing/sub/property/set_reply

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxxx"
}

表：响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码，用户自定义</td></tr>
<tr><td>msg</td><td>String</td><td>错误信息</td></tr>
</table>

**4. 子设备服务调用**
网关可代替子设备获取平台下发的服务调用，并返回设备执行结果。
>
>- 请求topic:$sys/{pid}/{device-name}/thing/sub/service/invoke

OneJSON数据格式:
> {
    "id":"123",
    "version":"1.0",
    "params":{
        "deviceName":"device1",
        "productID":"product1",
        "identifier":"xxxx",
        "input":{
            "Power1":"on",
            "WF1":"2"
        }
    }
}

表：请求参数说明
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>Object</td><td>请求入参，详情见表params</td></tr>
<tr><td>deviceName</td><td>String</td><td>子设备的设备名称</td></tr>
<tr><td>productID</td><td> String</td><td>子设备所属产品的productID</td></tr>
<tr><td>identifier</td><td>String</td><td>服务标识符</td></tr>
<tr><td>input</td><td>Object</td><td>服务的请求参数，参数类型具体见物模型对应的“服务”定义</td></tr>
</table>

>- 响应topic:$sys/{pid}/{device-name}/thing/sub/service/invoke_reply

OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxxx",
    "data":{
        "deviceName":"device1",
        "productID":"product1",
        "identifier":"xxxx",
        "output":{
            "result1":"on",
            "result2":"2"
        }
    }
}

>消息体中，参数productID和deviceName的值是子设备的对应信息

表:响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码，用户自定义</td></tr>
<tr><td>msg</td><td> String</td><td>错误信息</td></tr>
<tr><td>data</td><td>JsonObject</td><td>请求成功是，返回的服务调用结果，具体见表.data</td></tr>
<tr><td>deviceName</td><td>String</td><td>子设备的设备名称</td></tr>
<tr><td>productID</td><td> String</td><td>子设备所属产品的productID</td></tr>
<tr><td>identifier</td><td>String</td><td>服务标识符</td></tr>
<tr><td>output</td><td>Object</td><td>服务的响应参数，参数类型具体见物模型对应的“服务”定义</td></tr>
</table>

### OneJSON LwM2M拓展

**1. 设备上行数据**
OneJSON数据格式:
> {
  "id": "123",
  "version": "1.0",
  "params": {
    "Power": {
      "value": "on",
      "time": 1524448722123
    },
    "WF": {
      "value": 23.6,
      "time": 1524448722123
    }
  },
  "method":"thing.{功能类型}.{方法}"
}

表：请求参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>JsonObject</td><td>请求参数，标准json格式，内容同基础的OneJSON格式</td></tr>
<tr><td>method</td><td>String</td><td>上行数据业务类型，目前仅支持以下四种方法：thing.property.post、thing.event.post、thing.pack.post、thing.history.post</td></tr>
</table>

**2. 异步服务响应数据**
OneJSON数据格式:
> {
    "id":"123",
    "code":200,
    "msg":"xxxx",
    "data":{
        "result1":"on",
        "result2":"2"
    },
    "method":"thing.{功能类型}.{identifier}.reply"
}

表:响应参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>code</td><td>Integer</td><td>结果状态码</td></tr>
<tr><td>msg</td><td>String</td><td>错误信息</td></tr>
<tr><td>data</td><td>Object</td><td>请求参数，标准json格式，内容同基础的OneJSON格式</td></tr>
<tr><td>method</td><td>String</td><td>下行数据响应业务类型，目前仅支持服务异步响应：
thing.service.{identifier}.reply</td></tr>
</table>

**3. 设备下行数据**
OneJSON数据格式:
> {
  "id": "123",
  "version": "1.0",
  "params": {},
  "method":"thing.{功能类型}.{方法/服务标识符}"
}

表：请求参数描述
<table>
<tr><th width="15%">参数</th><th>类型</th><th width="70%">说明</th></tr>
<tr><td>id</td><td>String</td><td>消息id号，用户自定义，String类型的数字，长度限制不超过13位</td></tr>
<tr><td>version</td><td>String</td><td>物模型版本号，可选字段，不填默认为1.0</td></tr>
<tr><td>params</td><td>JsonObject</td><td>请求参数，标准json格式，内容同基础的OneJSON格式</td></tr>
<tr><td>method</td><td>String</td><td>上行数据业务类型，目前仅支持以下3种方法：
thing.property.set、
thing.property.get、
thing.service.{identifier}</td></tr>
</table>

## 数据解析

### 什么是数据解析

**1. 服务概述**
平台与设备通过OneJSON数据协议进行通信，OneJSON是一套基于JSON的用户层协议，具有可读性高的特点，能够直观展示数据交互细节。但在物联网场景中，存在低配置且资源受限的设备，往往不适合直接使用JSON数据格式，而是采用二进制数据格式与平台进行通信。针对该应用场景，平台提供数据解析功能，支持通过编写数据解析脚本实现自定义数据格式（二进制）与标准物模型数据格式之间的转换。如下为数据解析整体流程：
![服务概述](/images\device-management\服务概述.png)
数据解析脚本定义设备与平台间数据处理规则。设备上报数据时，平台将接收数据先运行解析脚本，将自定义数据转换成标准物模型数据，再进行后续业务处理。平台下发命令给设备时，也会先通过数据解析脚本将物模型数据转换为设备侧自定义数据，再下发给设备。
使用流程
数据解析功能包括产品创建、产品物模型定义、数据脚本开发及设备端逻辑开发四个步骤。

- 产品创建

数据解析功能只支持产品节点类型为直连设备，且接入协议为MQTT或LwM2M。产品创建时，需要选择数据协议为透传/自定义。具体操作参见[创建产品](https://open.iot.10086.cn/doc/v5/develop/detail/109)。

- 产品物模型定义

产品定义物模型，将设备侧功能按照属性、服务和事件三种类型功能点进行抽象及描述。具体操作参见[开发产品物模型](https://open.iot.10086.cn/doc/v5/develop/detail/506)。

- 数据脚本开发

数据解析脚本定义了设备自定义二进制数据与平台物模型Json数据间解析、转换规则。按照平台规范完成上下行解析函数编写、调试及发布后，平台即可对设备数据进行处理。脚本具体操作见[脚本开发](https://open.iot.10086.cn/doc/v5/develop/detail/517)。

- 设备逻辑开发

平台定义了MQTT协议、LwM2M协议使用自定义数据通信的专属资源信息，用户按照规范完成设备业务逻辑开发，即可使用自定义数据格式与平台进行上下行通信。具体操作见：[MQTT设备开发、LmM2M设备开发](https://open.iot.10086.cn/doc/v5/develop/detail/518)。

### 脚本开发

**1. 脚本编辑**

透传/自定义产品详情页面，选择数据解析标签，页面展示脚本编辑框，用户在编辑框内完成数据解析脚本开发，如图所示。
数据解析脚本支持以JavaScript语言开发，脚本需要实现如下两个函数方式：

- rawDataToJson：上行解析函数，按照产品物模型定义，将设备上报二进制数据转换为标准物模型Json数据格式，主要实现设备数据上报和命令回复响应两类数据解析。函数输出的物模型数据必须符合平台规范，具体格式要求见“物模型上行输出格式定义”
> /**
  *上行解析函数，将设备上报的自定义二进制数据解析为平台物模型数据
  *可实现两类数据的解析：设备上报数据及设备命令响应数据
  *@params rawData byte[]数组 设备上报的二进制字节数组
  *@return jsonObj json对象 解析后的物模型json数据，格式见文档说明
  */
function rawDataToJson(rawData）{
    var jsonObj = {};
    return jsonObj;
} 

jsonToRawData: 下行解析函数，将平台下发给设备的标准物模型数据转换为设备侧自定义二进制数据，主要实现平台命令下发和设备数据上报响应两类数据转换。平台物模型数据作为函数入参，具体格式要求见“物模型下行输入格式定义”。
> /**
 *下行转换函数，将平台下行的物模型JSON数据编码为设备自定义二进制数据
 *可实现两类数据的转换：平台命令下发及设备上报响应
 *@params jsonObj json对象 平台构造的物模型josn数据，格式见文档说明
 *@return rawData byte[]数组 转换后的二进制数据
 */
function jsonToRawData(jsonObj）{
    var rawData = [];
    return rawData;
}

**脚本开发说明：**

>(1)JavaScript语言开发，语法规则需遵循ECMAScript5.1规范。
(2)JavaScript脚本大小不能超过256K限制。
(3)脚本必须实现平台定义的两个函数方法，否则无法正常保存。
(4)上行解析函数输入参数和下行转换函数的输出参数均为字节数组，数组元素为整型，取值范围为[0,255]。
(5)脚本开发前，请确保已完成产品物模型功能点定义，且解析的物模型数据在平台有对应功能点。

**2. 脚本调试及发布**

脚本编辑完成后进行在线脚本调试，调试页面选择模拟输入类型，输入模拟数据，点击调试按钮，测试脚本功能，如图所示。
脚本调试模拟输入包括以下两种：
<table>
<tr><th width="15%">模拟输入类型</th><th>输入说明</th><th width="70%">示例</th></tr>
<tr><td>设备上行数据</td><td>模拟设备上报自定义二进制数据</td><td>输入以0x开头的十六进制字符串，例如：0xffff</td></tr>
<tr><td>设备下行数据</td><td>模拟平台下发物模型Json数据</td><td>输入json字符串，例如：{,"id":"16","version":"1.0","params":{"fileName":"12","size":12,"fileID":"12"},"method":"thing.service.$SyncGetFile.invoke"}</td></tr>
</table>
数据解析脚本经过调试即可进行发布操作，发布后，切换线上脚本标签，即可看到系统正在运行的数据解析脚本，如图所示。如需修改运行的解析脚本，切换至脚本草稿重新编辑发布。
https://open.iot.10086.cn/doc/iot_platform/images/iot_platform/script/数据解析脚本发布.png

**调试及发布说明**
>(1)脚本只有调试通过后（即脚本运行正常，无异常报错），才能进行发布操作。
(2)页面「开启脚本对比」功能，提供草稿箱脚本与线上运行脚本文件对比功能。
(3)页面「导入线上脚本」功能，可将线上运行脚本直接加载至当前脚本编辑框中，加载时会覆盖脚本草稿里已有文件内容。

**3. 物模型上行输出格式定义**

物模型上行输出类型包括：属性上报、事件上报、属性设置响应、属性获取响应、服务调用响应。
>// 属性上报
{ 
    "id": "1001",
    "version": "1.0",
    "params": {
        "power": {
            "value"："30.5"，
            "time": 1524448722123
        } 
    },
    "method": "thing.property.post"
}
// 事件上报
{ 
    "id": "1001",
    "version": "1.0",
    "params": {
        "identifier": {
            "value"：{
                "power": "on",
                "switch": "on"
            } 
        }  
    }
    "method": "thing.event.post"
}
// 批量数据上报
{ 
    "id": "1001",
    "version": "1001",
    "params": [{
        "properties": {
            "power": {
                "value"："30.5"，
                "time": 1524448722123
            } 
        },
        "event"：{
            "alarmEvent1": {
                "value": {
                    "Power":"on",
                    "WF":"2"
                },
                "time":1524448722000
            },
        }
    }],
    "method": "thing.pack.post"
}
// 历史数据上报
{ 
    "id": "1001",
    "version": "1001",
    "params": [{
        "properties": {
            "power": [{
                "value"："30.5"，
                "time": 1524448722123
            },{
                "value"："30.5"，
                "time": 1524448722170
            }] 
        },
        "event"：{
            "alarmEvent1": [{
                "value": {
                    "Power": "on",
                    "WF": "2"
                },
                "time":1524448722000
            },{
                "value": {
                    "Power": "on",
                    "WF": "10"
                },
                "time":1524448722111
            }]
        }
    }],
    "method": "thing.pack.post"
}
// 属性设置响应
{ 
    "id": "1001",
    "code": 200,
    "msg":"success"，
    "method": "thing.property.set.reply"
}
// 属性获取响应
{ 
    "id": "1001",
    "code": 200,
    "msg": "success",
    "data": {
      "power": "on"
    }
    "method": "thing.property.get.reply"
}
// 服务调用响应
{ 
    "id": "1000",
    "code": 200,
    "msg": "success",
    "data": {
        "temperature" : "30.5"
    },
    "method": "thing.service.{identifier}.reply"  // identifier为服务标识
}

**5. 脚本示例**

本文以产品「温度传感器」为例，展示数据解析脚本的编写示例。在产品下创建物模型功能：1）属性功能点，功能名称（电源开关），标识符（power），数据类型（int32），数据解析脚本如下所示。

>var COMMAND_POST = 0x01 // 属性上报
var COMMAND_EVENT = 0x02 // 事件上报
var COMMAND_PACK = 0x03 // 批量上报
var COMMAND_HISTORY = 0x04 // 历史上报
var COMMAND_POST_REPLY = 0x00 // 上报数据返回结果
var COMMAND_SET = 0x05 // 属性设置设备返回结果
var COMMAND_SET_REPLY = 0x15 // 属性设置设备返回结果
var COMMAND_GET = 0x06 // 属性获取
var COMMAND_GET_REPLY = 0x16 // 属性获取返回
var THING_PROP_POST_METHOD = 'thing.property.post'
var THING_EVENT_POST_METHOD = 'thing.event.post'
var THING_PACK_POST_METHOD = 'thing.pack.post'
var THING_HISOTORY_METHOD = 'thing.history.post'
var THING_POST_REPLY_METHOD = 'thing.post.reply'
var THING_PROP_SET_METHOD = 'thing.property.set'
var THING_PROP_SET_REPLY_METHOD = 'thing.property.set.reply'
var THING_PROP_GET_METHOD = 'thing.property.get'
var THING_PROP_GET_REPLY_METHOD = 'thing.property.get.reply'
/**
  *示例数据：
  *1.设备上报属性
  *传入参数：
  *0x01010007  命令类型[1字节]+消息id[1字节]+数据值[2字节] - 功能点power
  *输出结果：
  *{"method":"thing.property.post", "version":"1.0", "id":"1", "params":{"power": { "value": 7 } }}
  >*
  *2.属性设置的返回结果：
  *传入参数：
  *0x1502010008 命令类型[1字节]+消息id[1字节]+执行结果[1字节]+数据值[2字节] - 功能点power
输出结果：
  *{"id":"2", "code":200, "msg": "success", "data":{ "power": 8 }}
  */
function rawDataToJson (rawData) {
  var uint8Array = new Uint8Array(rawData.length)
  for (var i = 0; i < rawData.length; i++) {
    uint8Array[i] = rawData[i] & 0xff
  }
  var dataView = new DataView(uint8Array.buffer, 0)
  var jsonMap = { 'version': '1.0' }
 >var fHead = uint8Array[0] // 读取第一个字节为command命令
  if (fHead === COMMAND_POST) {
    jsonMap['method'] = THING_PROP_POST_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    var value = dataView.getInt16(2)
    jsonMap['params'] = {
       'power': {
          'value': value
       }
    }
  } else if(fHead == COMMAND_PACK) {
    jsonMap['method'] = THING_PACK_POST_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    var value = dataView.getInt16(2)
    jsonMap['params'] = [{
      'properties': {
        'power': [{
          'value': value,
          'time': Date.now()
        }]
      }
    }]
  } else if(fHead == COMMAND_HISTORY) {
    jsonMap['method'] = THING_HISOTORY_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    var value = dataView.getInt16(2)
    jsonMap['params'] = [{
      'properties': {
        'power': [{
          'value': value,
          'time': Date.now()
        }]
      }
    }]
  } else if (fHead === COMMAND_SET_REPLY) {
    jsonMap['method'] = THING_PROP_SET_REPLY_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    jsonMap['code'] = dataView.getUint8(2) ? 200 : 500
    jsonMap['msg'] = jsonMap['code'] ? 'success' : 'failed'
    jsonMap['data'] = {
      'power': dataView.getInt16(3) 
    }
  } else if (fHead === COMMAND_GET_REPLY) {
    jsonMap['method'] = THING_PROP_GET_REPLY_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    jsonMap['code'] = dataView.getUint8(2) ? 200 : 500
    jsonMap['msg'] = jsonMap['code'] ? 'success' : 'failed'
    jsonMap['data'] = { 
      'power': dataView.getUint16(3) 
    }
  }
  return jsonMap
}
/**
  *示例数据
  *1. 下发属性设置指令： 
  *传入参数：
  *{"method":"thing.property.set", "version": "1.0", "id": 2, "params":{ "power": 8 }}
  *输出结果：
  *0x05020008  命令类型[1字节]+消息id[1字节]+数据值[2字节]
  >*
  *2. 设备上报响应返回
  *传入参数：
  *{"method":"thing.post.reply", "id":"1", "code":200}
  *输出结果：
  *0x000101 命令类型[1字节]+消息id[1字节]+执行结果[1字节]
*/
function jsonToRawData (json) {
  var method = json['method']
  var id = json['id']
  var payloadArray = []
  if (method === THING_PROP_SET_METHOD) // 属性设置。
  {
    var params = json['params']
    var power = params['power']
    payloadArray = payloadArray.concat(buffer_uint8(COMMAND_SET)) // command字段。
    payloadArray = payloadArray.concat(buffer_uint8(parseInt(id))) // 消息id
    payloadArray = payloadArray.concat(buffer_int16(parseInt(power))) // 消息值
  } else if (method === THING_PROP_GET_METHOD) {
    var params = json['params']
    payloadArray = payloadArray.concat(buffer_uint8(COMMAND_GET)) // command字段。
    payloadArray = payloadArray.concat(buffer_uint8(parseInt(id)))
    payloadArray = payloadArray.concat(buffer_uint8(params.length))
  } else if (method === THING_POST_REPLY_METHOD) {
    var code = json['code']
    var value = code === 200 ? 1 : 0
    payloadArray = payloadArray.concat(buffer_uint8(COMMAND_POST_REPLY)) // 命令码
    payloadArray = payloadArray.concat(buffer_uint8(parseInt(id))) // 消息id
    payloadArray = payloadArray.concat(buffer_uint8(value)) // 消息值
  }
  return payloadArray
}
//将8位无符号整形转换为byte数组
function buffer_uint8(value) {
  var uint8Array = new Uint8Array(1);
  var dataView = new DataView(uint8Array.buffer);
  dataView.setUint8(0, value);
  return [].slice.call(uint8Array);
}
//将16位无符号整形转换为byte数组
function buffer_int16 (value) {
  var uint8Array = new Uint8Array(2)
  var dv = new DataView(uint8Array.buffer, 0)
  dv.setInt16(0, value)
  return [].slice.call(uint8Array)
}

### MQTT设备开发

**1. Topic定义**
MQTT设备使用自定义数据格式与平台通信时，订阅和发布Topic如下所示：
<table>
<tr><th width="20%">Topic类型</th><th>Topic</th><th width="60%">说明</th></tr>
<tr><td>数据上报</td><td>$sys/{pid}/{device-name}/custome/up</td><td></td></tr>
<tr><td>数据上报响应</td><td>$sys/{pid}/{device-name}/custome/up_reply</td><td></td></tr>
<tr><td>命令下发</td><td>$sys/{pid}/{device-name}/custome/down/{id}</td><td>topic中的消息{id}需采用通配符+号订阅</td></tr>
<tr><td>命令回复响应</td><td>$sys/{pid}/{devicename}/custome/down_reply/{id}</td><td>topic中的消息id，应与收到命令请求中的id保持对应关系</td></tr>
</table>

**2.  接入流程说明**

**数据上报流程**

![数据上报流程](/images\device-management\数据上报流程.png)
>说明：数据上报流程中，有两处需要用到脚本解析：
(1) 数据上报时，平台按照上行解析函数定义将自定义数据转换成平台规范的物模型数据，并发送只后续云服务处理。。
(2) 平台响应时，平台按照下行解析函数定义将响应物模型数据转换成自定义数据格式下发给设备。
（如果未对平台响应结果进行处理，则平台不会下发响应给设备）。

**命令下发流程**

属性设置、属性获取等命令下发时会在Topic中携带消息id，设备收到命令执行后，回复响应数据，应在发送的Topic中携带命令请求的消息id。

- 同步命令下发

![同步命令下发](/images\device-management\同步命令下发.png)

- 异步命令下发

images\device-management\数据上报.png

>说明：命令下发流程中，有两处需要用到脚本解析：
(1) 命令下发时，平台按照下行解析函数定义将物模型数据转换成自定义数据格式，发送给设备。
(2) 设备回复命令时，平台按照上行解析函数定义将设备响应自定义数据解析成物模型数据。

### LwM2M设备开发

**1. 资源定义**

LwM2M设备使用自定义数据格式与平台通信时，订阅和发送资源信息如下所示：
<table>
<tr><th width="20%">资源类型</th><th>资源（object/instance/resource</th><th width="60%">说明</th></tr>
<tr><td>数据上报</td><td>20/0/0</td><td></td></tr>
<tr><td>命令下发</td><td>20/1/0</td><td></td></tr>
<tr><td>命令数据回复</td><td>20/1/0</td><td>命令执行需要携带响应数据时，需要向该资源主动notify数据</td></tr>
</table>

**2. 接入流程说明**

**数据上报流程**

![数据上报流程](/images\device-management\数据上报.png)
>数据上报流程中，有一处需要用到脚本解析：
(1) 数据上报时，平台按照上行解析函数定义将自定义数据转换成平台规范物模型数据，并发送至后续云服务。

**命令下发流程**

属性设置、属性获取及服务调用等命令，会通过LwM2M协议的Write操作下发至设备，设备回复响应状态码，如需额外携带响应数据，则需要通过Notify操作将响应数据上报至平台。

- 同步命令下发

![同步命令下发](/images\device-management\同步下发.png)

- 异步命令下发

![异步命令下发](/images\device-management\异步下发.png)

>命令下发流程中，有两处需要用到脚本解析：
(1) 命令下发时，平台按照下行解析函数定义将物模型数据转换成自定义数据格式，发送给设备。
(2) 设备回复命令时，平台按照上行解析函数定义将设备响应自定义数据解析成物模型数据。

### 最佳实践

本节以M5310A模组，LwM2M接入协议为例，演示数据解析功能的使用流程。

**创建产品**

按照平台创建产品操作步骤，创建一个名称为后视镜、节点类型为直连设备、接入协议为LwM2M、数据协议为透传/自定义的产品，如图所示。

**开发产品物模型**

产品物模型管理页面，添加一个标识符为humi的浮点型功能点、标识符为temp的整数型功能点。

**设备数据上报测试**
**单个功能点上报测试**
产品数据解析功能页面，按照如下示例完成上行解析函数的编写。
>/**
  *示例数据：
  *设备属性上报
  *传入参数：
  *0x01010007  命令类型[1字节]+消息id[1字节]+数据值[2字节]
  *输出格式：
  *{"method":"thing.property.post", "version":"1.0", "id":"1", "params":{"temp": { "value": 2.0 } }}
  */
var COMMAND_POST = 0x01 // 属性上报
var THING_PROP_POST_METHOD = 'thing.property.post'
function rawDataToJson (rawData) {
  var uint8Array = new Uint8Array(rawData.length)
  for (var i = 0; i < rawData.length; i++) {
    uint8Array[i] = rawData[i] & 0xff
  }
  var dataView = new DataView(uint8Array.buffer, 0)
  var jsonMap = { 'version': '1.0' }
  var fHead = uint8Array[0] // 读取第一个字节为command命令
  if (fHead === COMMAND_POST) {
    jsonMap['method'] = THING_PROP_POST_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    var value = dataView.getInt16(2)
    jsonMap['params'] = {
      'temp': {
        'value': value
      }
    }
  } 
  return jsonMap
}
function jsonToRawData (json) {}

使用平台在线脚本调试工具，完成脚本上行函数调试并发布脚本。（模拟输入类型选择设备上行数据，输入数据为0x01010008）

>数据值：0x01010008
-01代表属性上报报文，01为消息id，0008为功能点temp的上报值
-命令类型[1字节]+消息id[1字节]+数据值[2字节]

![](https://open.iot.10086.cn/doc/iot_platform/images/iot_platform/script/脚本示例单功能调试.png

设备使用5310模组上报数据，如下为模组AT指令（他模组指令登录可参考模组手册和咨询模组技术人员）。

>AT  //模组返回ok，mcu和模组通信成功
AT+CSQ   //查询信号，一般12-31，数值越大越好。一般为20左右
AT+CEREG?  //网络附着情况，返回0,1为附着到网络
AT+MIPLCREATEEX="183.230.102.118:5683",0  //创建实体
AT+MIPLADDOBJ=0,20,2,"11",0,1  //订阅对象
AT+MIPLDISCOVERRSP=0,20,1,1,"0" //订阅资源
AT+MIPLOPEN=0,86400,30//登录
AT+MIPLNOTIFY=0,0,20,0,0,6,4,"01010008",0,0,18 //上报数据
-01代表属性上报报文，01为消息id，0008为功能点temp的上报值

**多个功能点上报测试**

>产品数据解析功能页面，按照如下示例修改上行解析函数，增加多个功能点的解析处理。
var COMMAND_POST = 0x01 // 属性上报
var COMMAND_EVENT = 0x02 // 事件上报
var COMMAND_PACK = 0x03 // 批量上报
var COMMAND_HISTORY = 0x04 // 历史上报
var COMMAND_POST_REPLY = 0x00 // 上报数据返回结果
var COMMAND_SET = 0x05 // 属性设置设备返回结果
var COMMAND_SET_REPLY = 0x15 // 属性设置设备返回结果
var COMMAND_GET = 0x06 // 属性获取
var COMMAND_GET_REPLY = 0x16 // 属性获取返回
var THING_PROP_POST_METHOD = 'thing.property.post'
var THING_EVENT_POST_METHOD = 'thing.event.post'
var THING_PACK_POST_METHOD = 'thing.pack.post'
var THING_HISOTORY_METHOD = 'thing.history.post'
var THING_POST_REPLY_METHOD = 'thing.post.reply'
var THING_PROP_SET_METHOD = 'thing.property.set'
var THING_PROP_SET_REPLY_METHOD = 'thing.property.set.reply'
var THING_PROP_GET_METHOD = 'thing.property.get'
var THING_PROP_GET_REPLY_METHOD = 'thing.property.get.reply'
/**
  *示例数据：
  *设备属性上报
  *传入参数：
  *0x01010007  命令类型[1字节]+消息id[1字节]+数据值[2字节]
  *输出格式：
  *{"method":"thing.property.post", "version":"1.0", "id":"1", "params":{"temp": { "value": 2.0 } }}
  */
function rawDataToJson (rawData) {
  var uint8Array = new Uint8Array(rawData.length)
  for (var i = 0; i < rawData.length; i++) {
    uint8Array[i] = rawData[i] & 0xff
  }
  var dataView = new DataView(uint8Array.buffer, 0)
  var jsonMap = { 'version': '1.0' }
  var fHead = uint8Array[0] // 读取第一个字节为command命令
  if (fHead === COMMAND_POST) {
    jsonMap['method'] = THING_PROP_POST_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    var value = dataView.getInt16(2)
    jsonMap['params'] = {
       'temp': {
          'value': value
       }
    }
  } else if(fHead == COMMAND_PACK) {
    jsonMap['method'] = THING_PACK_POST_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    var value = dataView.getInt16(2)
    jsonMap['params'] = [{
      'properties': {
        'humi': [{
          'value': value/10,
          'time': Date.now()
        }],
          "temp":[{
              "value":dataView.getInt16(4),
              'time': Date.now()
          }]
      }
    }]
  } else if(fHead == COMMAND_HISTORY) {
    jsonMap['method'] = THING_HISOTORY_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    var value = dataView.getInt16(2)
    //value = value、
    jsonMap['params'] = [{
      'properties': {
        'power': [{
          'value': value,
          'time': Date.now()
        }]
      }
    }]
  } else if (fHead === COMMAND_SET_REPLY) {
    jsonMap['method'] = THING_PROP_SET_REPLY_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    jsonMap['code'] =  dataView.getUint8(2)
    jsonMap['msg'] = jsonMap['code'] ? 'success' : 'failed'
    jsonMap['data'] = {
      'temp': dataView.getInt16(2) 
    }
  } else if (fHead === COMMAND_GET_REPLY) {
    jsonMap['method'] = THING_PROP_GET_REPLY_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    jsonMap['code'] = '' + dataView.getUint8(2)
    jsonMap['msg'] = jsonMap['code'] ? 'success' : 'failed'
    jsonMap['data'] = { 
      'power': dataView.getUint16(3) 
    }
  }
  return jsonMap
}
function jsonToRawData (json) {}

使用平台在线脚本调试工具，完成脚本上行函数调试并发布脚本（模拟输入类型选择设备上行数据，输入数据为0x030100080009。
>数据值：0x030100080009
-01代表属性上报报文，01为消息id，0008为功能点humi的上报值，0009为功能点temp的上报值

![](/images\device-management\运行结果.png)
>模组上行指令改为：
AT+MIPLNOTIFY=0,0,20,0,0,6,4,"030100080009",0,0,18
-01代表属性上报报文，01为消息id，0008为功能点humi的上报值，0009为功能点temp的上报值

**平台命令下发测试**

产品数据解析功能页面，按照如下示例完成下行转换函数的编写。

>var COMMAND_POST = 0x01 // 属性上报
var COMMAND_EVENT = 0x02 // 事件上报
var COMMAND_PACK = 0x03 // 批量上报
var COMMAND_HISTORY = 0x04 // 历史上报
var COMMAND_POST_REPLY = 0x00 // 上报数据返回结果
var COMMAND_SET = 0x05 // 属性设置设备返回结果
var COMMAND_SET_REPLY = 0x15 // 属性设置设备返回结果
var COMMAND_GET = 0x06 // 属性获取
var COMMAND_GET_REPLY = 0x16 // 属性获取返回
var COMMAND_SERVICE =0x07 //服务下发
var COMMAND_SERVICE_REPLY =0x17 //服务回复
var THING_PROP_POST_METHOD = 'thing.property.post'
var THING_EVENT_POST_METHOD = 'thing.event.post'
var THING_PACK_POST_METHOD = 'thing.pack.post'
var THING_HISOTORY_METHOD = 'thing.history.post'
var THING_POST_REPLY_METHOD = 'thing.post.reply'
var THING_PROP_SET_METHOD = 'thing.property.set'
var THING_PROP_SET_REPLY_METHOD = 'thing.property.set.reply'
var THING_PROP_GET_METHOD = 'thing.property.get'
var THING_PROP_GET_REPLY_METHOD = 'thing.property.get.reply'
/**
 >*
  *示例数据：
  *属性设置返回结果：
  *传入参数：
  *0x1502010008 命令类型[1字节]+消息id[1字节]+执行结果[1字节]+数据值[2字节]
  *输出结果：
  *{"id":"2", "code":"200", "msg": "success", "data":{ "power": 8 }}
 > *
  */
function rawDataToJson (rawData) {
  var uint8Array = new Uint8Array(rawData.length)
  for (var i = 0; i < rawData.length; i++) {
    uint8Array[i] = rawData[i] & 0xff
  }
  var dataView = new DataView(uint8Array.buffer, 0)
  var jsonMap = { 'version': '1.0' }
  var fHead = uint8Array[0] // 读取第一个字节为command命令
  (fHead === COMMAND_SET_REPLY) {
    jsonMap['method'] = THING_PROP_SET_REPLY_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    jsonMap['code'] =  dataView.getUint8(2)
    jsonMap['msg'] = jsonMap['code'] ? 'success' : 'failed'
    jsonMap['data'] = {
      'temp': dataView.getInt16(2) 
    }
  } else if (fHead === COMMAND_GET_REPLY) {
    jsonMap['method'] = THING_PROP_GET_REPLY_METHOD
    jsonMap['id'] = '' + dataView.getInt8(1)
    jsonMap['code'] = '' + dataView.getUint8(2)
    jsonMap['msg'] = jsonMap['code'] ? 'success' : 'failed'
    jsonMap['data'] = { 
      'power': dataView.getUint16(3) 
    }
  } else if(fHead === COMMAND_SERVICE_REPLY) {
    // 命令类型[1] + 消息ID[1] + 执行结果[1字节] + 服务类型[1字节] + 参数1[1字节]
    jsonMap['id'] = '' + dataView.getInt8(1)
    jsonMap['code'] = 200
    var serviceName = 'cmd'
    jsonMap['method'] = 'thing.service.' + serviceName + '.reply'
    jsonMap['data'] = { 
      'fan1': '1234'  // 回复的参数
    }
  } 
  return jsonMap
}
/**
  *示例数据
  *下发属性设置指令： 
  *传入参数：
  *{"method":"thing.property.set", "version": "1.0", "id": 2, "params":{ "power": 8 }}
  *输出结果：
  *0x05020008  命令类型[1字节]+消息id[1字节]+数据值[2字节]
  >*
  */
function jsonToRawData (json) {
  var method = json['method']
  var id = json['id']
  var payloadArray = []
  if (method === THING_PROP_SET_METHOD) // 属性设置。
  {
    var params = json['params']
    var temp = params['temp']
    var humi = params['humi']
    payloadArray = payloadArray.concat(buffer_uint8(COMMAND_SET)) // command字段。
    payloadArray = payloadArray.concat(buffer_uint8(parseInt(id))) // 消息id
    payloadArray = payloadArray.concat(buffer_int16(parseInt(temp))) // 消息值
    payloadArray = payloadArray.concat(buffer_uint8(COMMAND_SET)) // command字段。
    payloadArray = payloadArray.concat(buffer_uint8(parseInt(id))) // 消息id
    payloadArray = payloadArray.concat(buffer_int16(parseInt(humi))) // 消息值 
  } else if (method === THING_PROP_GET_METHOD) {    
    var params = json['params']
    payloadArray = payloadArray.concat(buffer_uint8(COMMAND_GET)) // command字段。
    payloadArray = payloadArray.concat(buffer_uint8(parseInt(id)))
    payloadArray = payloadArray.concat(buffer_uint8(params.length))  
  } else if (method === THING_POST_REPLY_METHOD) {
    var code = json['code']
    var value = code === 200 ? 1 : 0
    payloadArray = payloadArray.concat(buffer_uint8(COMMAND_POST_REPLY)) // 命令码
    payloadArray = payloadArray.concat(buffer_uint8(parseInt(id))) // 消息id
    payloadArray = payloadArray.concat(buffer_uint8(value)) // 消息值 
  } else if(method.startsWith('thing.service')){
    // 命令类型[1] + 消息ID[1] + 服务类型[1字节] + 服务参数1[2字节] + 服务参数2[2字节]
    var params = json['params']
    var serviceName = 1
    var cmd1 = params['cmd1']
    payloadArray = payloadArray.concat(buffer_uint8(COMMAND_SERVICE)) // command字段。
    payloadArray = payloadArray.concat(buffer_uint8(parseInt(id))) // 消息id
    payloadArray = payloadArray.concat(buffer_uint8(parseInt(serviceName))) // 消息类型
    payloadArray = payloadArray.concat(buffer_int16(parseInt(cmd1))) // 消息类型
  }
  return payloadArray
}
//将8位无符号整形转换为byte数组
function buffer_uint8(value) {
  var uint8Array = new Uint8Array(1);
  var dataView = new DataView(uint8Array.buffer);
  dataView.setUint8(0, value);
  return [].slice.call(uint8Array);
}
//将16位无符号整形转换为byte数组
function buffer_int16 (value) {
  var uint8Array = new Uint8Array(2)
  var dv = new DataView(uint8Array.buffer, 0)
  dv.setInt16(0, value)
  return [].slice.call(uint8Array)

**属性设置测试**

「运维监控」下选择设备调试功能，调试页面选择产品下某一设备，使用应用模拟器模拟平台属性设置命令下发。
![](/images\device-management\属性设置.png)
>设备侧收到： 
+MIPLWRITE:0,35605,20,1,0,2,16,050D0000050D0016,0
-05代表下行设置报文，0D为消息id，000b为temp参数设置值，05代表下行设置报文，0D为消息id，
0016为humi参数设置值
设备侧回复：
AT+MIPLWRITERSP=0,35605,2
-其中35605要和下行报文的msg id一致

**服务调用测试**
功能测试前，在产品物模型下添加服务功能点，标识符cmd，调用方式同步。
「运维监控」下选择设备调试功能，调试页面选择产品下某一设备，使用应用模拟器模拟平台服务命令下发。
![](/images\device-management\调试设备.png)
>设备侧收到： 
+MIPLWRITE:0,27233,20,1,0,2,10,073C01000C,0
-07代表服务调用报文，3C为消息id，01代表服务参数类型（整型、浮点型等），000C为服务参数cmd1的设置值
设备侧回复：
AT+MIPLWRITERSP=0,27233,2
AT+MIPLNOTIFY=0,0,20,1,0,6,4,"173C",0,0
-17代表下行服务报文, 3C为消息id

![](/images\device-management\服务调用.png)