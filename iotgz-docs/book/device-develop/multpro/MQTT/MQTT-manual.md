# MQTT接入说明

测试接入流程分为平台域和设备域，用于帮助您进行首次接入体验，以便对平台的功能以及接入协议有大致的了解。

**测试流程图**

![PIC](/images/MQTT/测试流程图1.jpg)

**接入步骤**如下：

**Step1 创建产品，选择接入协议**

首先您需要在平台创建一个**接入协议为MQTT**的产品，查看[产品创建](/book/easy-manual/product&device/product-create.md)

创建产品后，记录该产品的产品ID

**Step2 创建设备，记录设备ID等信息**

创建设备有两种方式：

第一种 可以通过页面点击**添加设备**，输入**设备名称**和**鉴权信息**（即设备编号），具体平台的资源模型可详情请查看第一章 [资源模型](/book/introduce/resource-model.md)，并记录下该**设备编号**.

第二种 可以通过调用创建设备API 实现设备的创建，输入设备的设备名、接入协议、鉴权信息以及MasterKey等信息，即可在平台上创建设备。

**Step3 建立设备与平台间的协议连接**

MQTT服务器地址域名为：**mqtt.heclouds.com**

使用Step1和step2中的参数作为登录参数，使用SDK中的对应接口组织MQTT连接报文，发送到平台，与平台建立MQTT连接

若已经连接成功，在设备信息中会看到一个在线标记：

![pic](/images/MQTT/在线.png)

**Step4 数据流创建，数据点上传**

利用SDK中提供的接口函数，编写代码将数据上传到平台

**Step5  数据流展示，查看数据点**

在OneNET上的设备管理下点击数据展示，进入数据展示页面，点击下拉菜单，查看近期上传的数据点；也可以选择时间区间来查看历史时间


## 常见问题
----------

**Q1：MQTT连接鉴权时,Payload中ClientIdentifier;UserName;UserPassword分别填写什么？**

**A**： **ClientIdentifier**: 创建设备时得到的设备ID，为数字字串； 
    
   **UserName**: 注册产品时，平台分配的产品ID，为数字字串； 

  **UserPassword**: 为设备的鉴权信息（即唯一设备编号，SN），或者为apiKey，为字符串。

**Q2：MQTT需要在连接鉴权通过后才能发送其它报文吗？**

**A**：是的，MQTT协议必须在鉴权通过后(收到ConnAck后)，才能发送后续报文进行交互，不然服务器会直接丢弃报文。

**Q3：MQTT可以订阅Topic有什么限制？**

**A**： OneNET不支持订阅$开头的系统Topic。

**Q4：如何利用MQTT协议上传数据到云平台？**

**A**：设备完成连接鉴权之后，将数据按照一定的格式（见协议文档说明）打包，将数据发布到$dp系统Topic上即可。

**Q5：订阅之前是否需要创建Topic？**

**A**：设备在执行订阅时，OneNET会自动判断该Topic是否存在，若不存在则自动创建该Topic。

**Q6：设备可否通过订阅的方式，获取其他设备的数据流信息？**

**A**：可以，可以通过订阅 **/device_id/数据流名** 的方式，及时获取到某设备最新的数据点信息。

**Q7：设备发布消息(Publish)有什么限制？？**

**A**：发布消息只能在同一产品ID下进行，不能进行跨产品间的Publish消息推送。